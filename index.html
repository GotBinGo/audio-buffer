<html>
<body>
    <div>hello</div>
    <!-- <textarea style="width: 500px; height:500px;" id="code" value="">wave = (i) => {
const t = i / sampleRate;

return Math.sin(2*Math.PI*440*t)+Math.sin(2*Math.PI*500*t)







}</textarea> -->
    <button onclick="exec()">run</button>
    <br>
    <br>
    <br>
    
    <audio id="audioElement" controls></audio>
    <script defer src="http://localhost:3000/script.js" data-website-id="061d6ca4-b9ec-442a-89ee-75c6142bde57"></script>
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const sampleRate = 44100;
        var tl = 5;
        const buffer = audioCtx.createBuffer(1, sampleRate*tl, sampleRate);

        const channelData = buffer.getChannelData(0);

        function wave(i) {
            const t = i / sampleRate;
            return Math.sin(2*Math.PI*(440)*t)
        }






        r = []
        function rn(n) {
            if(r[n])
                return r[n];
            r[n] = Math.random();
            return r[n];
        }

        function hzf(hz, s) {
            return hz + (Math.sin(s*5)*10)
        }

        function divd(s, hz, n) {
            return Math.sin(2 * Math.PI * hzf(hz, s) * s)
        }

        function exec() {
            console.log('starting');
            play(window?.code?.value)
        }
        

        function play(code) {
            for (let i = 0; i < channelData.length; i++) {
                const t = i / sampleRate;
  
                channelData[i] = wave(i);
            }

            //normailze
            // var max = 0;
            // for (let i = 0; i < sampleRate*tl; i++) {
            //     if (channelData[i] > max)
            //         max = channelData[i]
            // }

            // for (let i = 0; i < sampleRate*tl; i++) {
            //     channelData[i] = channelData[i] / max
            // }

            function audioBufferToWav(buffer) {
                const numOfChan = buffer.numberOfChannels;
                const length = buffer.length * numOfChan * 2 + 44;
                const bufferArray = new ArrayBuffer(length);
                const view = new DataView(bufferArray);

                function writeString(view, offset, string) {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                }

                let offset = 0;
                writeString(view, offset, 'RIFF'); offset += 4;
                view.setUint32(offset, 36 + buffer.length * numOfChan * 2, true); offset += 4;
                writeString(view, offset, 'WAVE'); offset += 4;
                writeString(view, offset, 'fmt '); offset += 4;
                view.setUint32(offset, 16, true); offset += 4;
                view.setUint16(offset, 1, true); offset += 2;
                view.setUint16(offset, numOfChan, true); offset += 2;
                view.setUint32(offset, buffer.sampleRate, true); offset += 4;
                view.setUint32(offset, buffer.sampleRate * numOfChan * 2, true); offset += 4;
                view.setUint16(offset, numOfChan * 2, true); offset += 2;
                view.setUint16(offset, 16, true); offset += 2;
                writeString(view, offset, 'data'); offset += 4;
                view.setUint32(offset, buffer.length * numOfChan * 2, true); offset += 4;

                for (let i = 0; i < buffer.length; i++) {
                    for (let channel = 0; channel < numOfChan; channel++) {
                        let sample = buffer.getChannelData(channel)[i];
                        sample = Math.max(-1, Math.min(1, sample));
                        view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                        offset += 2;
                    }
                }
                return bufferArray;
            }

            const wavData = audioBufferToWav(buffer);
            const blob = new Blob([wavData], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);

            const audioElement = document.getElementById("audioElement");
            audioElement.src = url;
            audioElement.play()
        }
    </script>
</body>
</html>